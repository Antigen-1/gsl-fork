/* Author:  G. Jungman
 * RCS:     $Id$
 */
#include <math.h>
#include <gsl_math.h>
#include <gsl_errno.h>
#include "gsl_sf_chebyshev.h"

#include "airy_impl.h"
#include "bessel.h"

#define CubeRoot2_ 1.25992104989487316476721060728


/* Chebyshev fit for f(x) = A_2(2/(x+1)) / (1+x) */
static double A2_gt1_data[28] = {
  0.00042740836099373760083877383820,
  0.000198015693944389527785047335096,
 -0.000054454552746900308473446906559,
 -0.0000222673228383085134964757854674,
  0.0000152232502016475221849527768055,
 -3.3243013103482365073560071893e-6,
 -5.3060213036097467515440647626e-7,
  8.0934253293797313682621766902e-7,
 -4.3970412810377017046814010185e-7,
  1.79071424519372576492608662140e-7,
 -6.2467398631792389300175040895e-8,
  1.96894735620475710289112015304e-8,
 -5.7675858040046097235060721371e-9,
  1.59728455317871235349735453543e-9,
 -4.2302024090656279644231530804e-10,
  1.08004643558298536450496126138e-10,
 -2.67437492468402217094751959285e-11,
  6.4518542339596162421910187855e-12,
 -1.52189607648056016027864364660e-12,
  3.5202190883266175011615161782e-13,
 -8.0030236559195190012512311175e-14,
  1.79175234158451644829625971592e-14,
 -3.9568041553037887210172021266e-15,
  8.6307619819767052015119074384e-16,
 -1.86166067383562915065864440616e-16,
  3.9750004549810259594153022435e-17,
 -8.4088913756029427849463017114e-18,
  1.76364042377515061860916815522e-18
};
static struct gsl_sf_ChebSeries A2_gt1_cs = {
  A2_gt1_data,
  -1, 1,
  27,
  (double *)0,
  (double *)0
};


/* Chebyshev fit for f(x) = A_3(2/(x+1)) / (1+x)^3 */
static double A3_gt1_data[24] = {
  -0.000105857038770346154791201255476,
  -0.0000205760351047268016023585098044,
   0.000038843887932590651228554092924,
  -6.4950843727032906490961018776e-6,
  -6.8550260909371744214172673062e-6,
   5.2395352749196099765976515407e-6,
  -1.69616633544227242227774179427e-6,
   1.72521003343504841706687755356e-8,
   3.3883914247036941743279709445e-7,
  -2.57613705551957452862302913685e-7,
   1.33889960634289278564724992969e-7,
  -5.7713728962127577476860031398e-8,
   2.20603248663723535274887935371e-8,
  -7.7303494297479242603927953267e-9,
   2.53299507665549622149741647084e-9,
  -7.8631261188698187150310486463e-10,
   2.33399931618284706272149336039e-10,
  -6.6701601102133563477507979861e-11,
   1.84501510088942544841583986784e-11,
  -4.9603190140521104131104222919e-12,
   1.30057299865001322997537278176e-12,
  -3.3349097589870270196152533718e-13,
   8.3823663352585629972074916939e-14,
  -2.06935497620521059555227840228e-14
};
static struct gsl_sf_ChebSeries A3_gt1_cs = {
  A3_gt1_data,
  -1, 1,
  23,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = A_4(2/(x+1)) / (1+x)^6 */
static double A4_gt1_data[26] = {
  0.000125697283425688142589675543269,
 -0.000050645627237786588390079633647,
 -0.000039523054096351623293093854162,
  0.000057233311931568390938392835355,
 -0.000031818911485741499201551433084,
  6.4630306602531574860998297458e-6,
  5.0616158021126428255733925911e-6,
 -6.7407685406543455758532219238e-6,
  4.8341191834954372840684909135e-6,
 -2.70284302737585171364127644280e-6,
  1.29809485449060809996826398344e-6,
 -5.5948881492166591185215676134e-7,
  2.21873458997287954929794202862e-7,
 -8.2273391038697083553968704589e-8,
  2.88517129977479831153315334786e-8,
 -9.6490353350664257722239934671e-9,
  3.09741804319220014767274501469e-9,
 -9.5927055920771069102325406448e-10,
  2.87811779486393554072126307871e-10,
 -8.3943741994472279152448683929e-11,
  2.38685008387210470508473521366e-11,
 -6.6324583097725665510560899982e-12,
  1.80484949515000434413648585876e-12,
 -4.8184427425193604532856573999e-13,
  1.26401843842725195998270509521e-13,
 -3.2627161256373377812579127042e-14
};
static struct gsl_sf_ChebSeries A4_gt1_cs = {
  A4_gt1_data,
  -1, 1,
  25,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = B_1(2/(x+1)) */
static double B1_gt1_data[30] = {
  -0.00125638387443615968469140078230,
  -0.00079518496830875387886042742516,
  -0.000117550533792019687221797909112,
   0.000053177832099392027220254310301,
  -2.69942462974709280278958305596e-6,
  -3.8442655040391955801226902901e-6,
   1.93735278352654820441613088112e-6,
  -5.7567177444348444716886594860e-7,
   1.09655991539838265398335388742e-7,
  -3.9493463262644952802342029354e-10,
  -1.29925137787315793022146720225e-8,
   9.0685864569780974583429213845e-9,
  -4.9217596347029779922435454110e-9,
   2.52379362404573993294129066226e-9,
  -1.30781535782041343419561644550e-9,
   7.0384726336811679054311137949e-10,
  -3.9656903287869259099757487561e-10,
   2.33557792366149146495284096555e-10,
  -1.43039836294329736948171530669e-10,
   9.0574939745376874544020136846e-11,
  -5.8990591168315025785999930659e-11,
   3.9336908506031143837035749223e-11,
  -2.67442765030341217028365302040e-11,
   1.84575544800677159001265401512e-11,
  -1.28626375497176648076677290858e-11,
   8.9834445611871474998305912925e-12,
  -6.2114446574034950328703160154e-12,
   4.1547451016435261417400468910e-12,
  -2.55075855193449883493817495022e-12,
   1.21351807208778202835648785394e-12
};
static struct gsl_sf_ChebSeries B1_gt1_cs = {
  B1_gt1_data,
  -1, 1,
  29,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = B_2(2/(x+1)) / (1+x)^2 */
static double B2_gt1_data[28] = {
  0.000171948661718211851305571216621,
  0.000079514741279756654016155767774,
 -0.0000231980045534389356735443835521,
 -9.6608078112814154253915121642e-6,
  6.9234246115168214059342873692e-6,
 -1.37541247706222772353756248204e-6,
 -4.3232083748880289164411169258e-7,
  4.7506644879380763788488850903e-7,
 -2.28714945515401399251738734230e-7,
  7.6411016497329937280971501352e-8,
 -1.68648036990450591006180459630e-8,
 -4.7817821661397417398426456903e-12,
  2.77300632054028838759266566595e-9,
 -2.20212690117293776747358435428e-9,
  1.33978703926356648679100873427e-9,
 -7.5528675426754967540212371899e-10,
  4.2211557074388851904570120605e-10,
 -2.41136554272714597841816511490e-10,
  1.42538905397504612817193580626e-10,
 -8.7372629703949883171709170161e-11,
  5.5382078895910144286543982412e-11,
 -3.6132035104786592416603496209e-11,
  2.41397234409420703745082294584e-11,
 -1.64282187755817239822773509280e-11,
  1.13202145709942687808326952275e-11,
 -7.8352182544028993620167163596e-12,
  5.3791924356175443953371734348e-12,
 -3.5787357658563595558317302866e-12
};
static struct gsl_sf_ChebSeries B2_gt1_cs = {
  B2_gt1_data,
  -1, 1,
  27,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = B_3(2/(x+1)) / (1+x)^4 */
static double B3_gt1_data[20] = {
 -0.000068009673419090927225387261907,
 -0.0000145500861241893523948226067198,
  0.0000247040089452551896538841109199,
 -3.3655085203990813669030177737e-6,
 -5.0256936615910799672373117859e-6,
  3.4911651339149073422247693091e-6,
 -9.2101643160428802140429959436e-7,
 -1.81147876895751168216073606468e-7,
  3.2729110855886801301636677309e-7,
 -2.02381622404891060649804719656e-7,
  8.7092212917564597086618220176e-8,
 -2.77012530592106968759675108406e-8,
  5.0573485395098675402499310920e-9,
  1.28503905631549093257494403354e-9,
 -2.09288752128351883056489212967e-9,
  1.56624781741056759624616004765e-9,
 -9.7137955394968277537261356951e-10,
  5.5550828438159189367468447195e-10,
 -2.95107679319668330634231529361e-10,
  1.27190601726923840842472534518e-10
};
static struct gsl_sf_ChebSeries B3_gt1_cs = {
  B3_gt1_data,
  -1, 1,
  19,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = (1-x^2) B_2(((x+1)/2)^2) */
static double B2_lt1_data[35] = {
  0.00084026395088264015099502245928,
  0.000088181444032201759266338547721,
 -0.00051171108522196065221366017009,
 -0.000134672618379561301360183037036,
  0.000115395060417566152111983130570,
  0.000058735388180039418242324491349,
 -0.000032176986064350477997596692485,
 -0.0000126713499261043208147850443271,
  9.7592340315628013596304570613e-6,
  3.2220738550539811972370787096e-7,
 -1.71728045241376553564331034836e-6,
  3.14226872087315600297751158038e-7,
  2.13152361503209526570034842054e-7,
 -1.30531706592228770463244159072e-7,
  3.3453809427690885647035273971e-8,
 -1.38547410573123242361383251224e-8,
  1.58902702831411610378068108236e-8,
 -1.53399719002529394868952667624e-8,
  1.25923113922933843948618620738e-8,
 -1.01239031569578512225384479335e-8,
  8.3288722158131788482937778713e-9,
 -6.9570576561827147414356739024e-9,
  5.8430182340271064907579424268e-9,
 -4.9203021357546511598312897487e-9,
  4.1504604159968444238674786759e-9,
 -3.5020026165275894631128470024e-9,
  2.94931117532339827900065827918e-9,
 -2.47237431488972885292909357095e-9,
  2.05552906693258419584528417460e-9,
 -1.68628023667967007292111215996e-9,
  1.35446423243500486244254545064e-9,
 -1.05165387751767815798810001690e-9,
  7.7070867689322668325657946539e-10,
 -5.0542189855453967558009103714e-10,
  2.50235358220043539959858936622e-10
};
static struct gsl_sf_ChebSeries B2_lt1_cs = {
  B2_lt1_data,
  -1, 1,
  34,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = (1-x^2) B_3(((x+1)/2)^2) */
static double B3_lt1_data[22] = {
 -0.000106229614184612043918321571285,
  0.00036877091818979315480566858327,
  0.000174038708669146201617225574415,
 -0.000045059108565467836525233400367,
 -0.000095526870718208241675088705583,
  2.86509585706885128080053289999e-8,
  0.000035676831328572445158713984398,
 -2.51855476991491308222019565350e-6,
 -9.7449614753469127963136934038e-6,
  2.30279458696087078771325936103e-6,
  1.81463131082845973206943613851e-6,
 -9.5181091512810041453031607852e-7,
 -7.4871935763601053004797515116e-8,
  1.63116389082457287027231720180e-7,
 -1.50398328414435518585245182069e-8,
 -3.2363857483268698220756148270e-8,
  1.98751326516231316393595934333e-8,
 -8.0990540672071245456832786753e-9,
  5.1597939304599884820265890917e-9,
 -4.6103910295965128798622587614e-9,
  3.7628268616432913851489363118e-9,
 -2.70104404260423813985131720854e-9
};
static struct gsl_sf_ChebSeries B3_lt1_cs = {
  B3_lt1_data,
  -1, 1,
  21,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = (1-x^2) A_3(((x+1)/2)^2) */
static double A3_lt1_data[40] = {
  0.000046453520358433328476671530033,
 -0.000098203862363179084728748914242,
 -0.000097516129465749448909352582421,
  0.000134781755103817358219477386943,
  0.000113068260642459310245655047556,
 -0.000052865072953175182897123646235,
 -0.000049307320663817513021052940731,
  0.0000231114654199807943291810573172,
  0.0000114028599004124626286025402457,
 -8.5068650262863043050881612171e-6,
 -5.7601858941336028828660613707e-7,
  1.88767901149823052826317927046e-6,
 -4.0624629506438652564959250545e-7,
 -1.99906990924843779695510830848e-7,
  1.16761843534503380932621317344e-7,
 -4.9504642170249153411376293787e-9,
 -1.28373945267760153150539076615e-8,
  3.1720626031266170889993759155e-9,
  1.33350501785623726812903764650e-9,
 -1.24518438037802803122295040950e-9,
  6.3005105946284033941657723981e-10,
 -4.0892685917017015028926750280e-10,
  3.5538484369705908436060265393e-10,
 -3.14434111030771561215667770461e-10,
  2.69113985162882988854528655326e-10,
 -2.28554648414780567279577369564e-10,
  1.95043145322215320131113697202e-10,
 -1.67147550996695119719467166694e-10,
  1.43455582721166943401756715652e-10,
 -1.23082810764680012369243738944e-10,
  1.05407497700895474868802909711e-10,
 -8.9931078614000503826608774117e-11,
  7.6243435515752335441196088949e-11,
 -6.4007495859760950506727429763e-11,
  5.2944053710945583198545702885e-11,
 -4.2818416224123951613450441033e-11,
  3.3429881118217421146081940973e-11,
 -2.46034765148911293703893867732e-11,
  1.61832681931702237848446380314e-11,
 -8.0267537472386768274375559337e-12
};
static struct gsl_sf_ChebSeries A3_lt1_cs = {
  A3_lt1_data,
  -1, 1,
  39,
  (double *)0,
  (double *)0
};

/* Chebyshev fit for f(x) = (1-x^2) A_4(((x+1)/2)^2) */
static double A4_lt1_data[18] = {
 -0.000069571514873001943530279629740,
  0.000069038870993972311389418234488,
  0.000133108104124366632147552913603,
 -0.000065870474209908331517503636669,
 -0.000160332373316402079547731861049,
 -0.0000130049151055745542322821390303,
  0.000090073173021663379223645760416,
  0.0000109570460627833079771194049005,
 -0.000037776084884583105770148632400,
  5.6338773687325427090705882481e-7,
  0.0000119056330672690784808296502518,
 -2.66745825895048191548132883761e-6,
 -2.38986673865981846505433135457e-6,
  1.22696783489401075408768689513e-6,
  1.67957412505960053617791763087e-7,
 -2.79225443319286037247280223101e-7,
  4.6837485501713204499021187383e-8,
  3.3286440259800781902717784785e-8,
};
static struct gsl_sf_ChebSeries A4_lt1_cs = {
  A4_lt1_data,
  -1, 1,
  17,
  (double *)0,
  (double *)0
};


static double olver_B0(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT4_MACH_EPS) {
    double a = 1.-z;
    return CubeRoot2_ * (1./70.  + 2./225.*a + 953./202125.*a*a + 17942./7882875.*a*a*a);
  }
  else if(z < 1.) {
    double t = 1./sqrt((1-z)*(1+z));
    return -5./(48.*abs_zeta*abs_zeta) + t*(-3 + 5.*t*t)/(24.*sqrt(abs_zeta));
  }
  else {
    double t = 1./sqrt((z-1)*(z+1));
    return -5./(48.*abs_zeta*abs_zeta) + t*( 3 + 5.*t*t)/(24.*sqrt(abs_zeta));
  }
}

static double olver_B1(double z, double abs_zeta)
{
  if(fabs(1.-z) < sqrt(GSL_ROOT3_MACH_EPS)) {
    double a = 1.-z;
    return -0.00149282953213429172050073403334
           -0.00175640941909277865678308358128 * a
	   -0.00113346148874174912576929663517 * a*a
	   -0.00034691090981382974689396961817 * a*a*a
	   +0.00022752516104839243675693256916 * a*a*a*a
	   +0.00051764145724244846447294636552 * a*a*a*a*a
	   +0.00058906174858194233998714243010 * a*a*a*a*a*a
	   ;
  }
  else if(z < 1.) {
    double t   = 1./sqrt((1-z)*(1+z));
    double t2  = t*t;
    double rz  = sqrt(abs_zeta);
    double z32 = rz*rz*rz;
    double z92 = z32*z32*z32;
    double term1 = t*t*t * (30375. - 369603.*t2 + 765765.*t2*t2 - 425425.*t2*t2*t2)/414720.;
    double term2 = 85085./(663552.*z92);
    double term3 = 385./110592.*t*(3.-5.*t2)/(abs_zeta*abs_zeta*abs_zeta);
    double term4 = 5./55296.*t2*(81. - 462.*t2 + 385.*t2*t2)/z32;
    return -(term1 + term2 + term3 + term4)/rz;
  }
  else {
    return gsl_sf_cheb_eval(2./z - 1., &B1_gt1_cs);
  }
}

static double olver_B2(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT4_MACH_EPS) {
    double a = 1.-z;
    return   0.00055221307672129279005986982501
           + 0.00089586516310476929281129228969 * a
	   + 0.00067015003441569770883539158863 * a*a
	   + 0.00010166263361949045682945811828 * a*a*a
	   ;
  }
  else if(z < 1.) {
    double x  = 2.*sqrt(z) - 1.;
    double f2 = 1./(1-x*x);
    return f2 * gsl_sf_cheb_eval(x,&B2_lt1_cs);
  }
  else {
    double x  = 2./z - 1.;
    double f2 = (1+x)*(1+x);
    return f2 * gsl_sf_cheb_eval(x,&B2_gt1_cs);
  }
}

static double olver_B3(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT4_MACH_EPS) {
    double a = 1.-z;
    return -0.00047461779655995980754441833105
           -0.00095572913429464297452176811898 * a
	   -0.00080369634512082892655558133973 * a*a
	   -0.00000727921669154784138080600339 * a*a*a
	   ;
  }
  else if(z < 1.) {
    double x  = 2.*sqrt(z) - 1.;
    double f2 = 1./(1-x*x);
    return f2 * gsl_sf_cheb_eval(x,&B3_lt1_cs);
  }
  else {
    double x  = 2./z - 1.;
    double f2 = (1+x)*(1+x);
    return f2*f2 * gsl_sf_cheb_eval(x,&B3_gt1_cs);
  }
}

/* checked OK {GJ] Wed Apr 29 15:30:17 MDT 1998 */
static double olver_A1(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT4_MACH_EPS) {
    double a = 1.-z;
    return -1./225.
           -71./38500.             * a 
           +25591./45045000.       * a*a
	   +2982172./1773646875.   * a*a*a
	   +25025359./13400887500. * a*a*a*a
	   ;
  }
  else if(z < 1.){
    double t = 1./sqrt((1-z)*(1+z));
    double rz = sqrt(abs_zeta);
    double t2 = t*t;
    double term1 =  t2*(81. - 462.*t2 + 385.*t2*t2)/1152.;
    double term2 = -455./(4608.*abs_zeta*abs_zeta*abs_zeta);
    double term3 =  7.*t*(-3 + 5.*t2)/(1152.*rz*rz*rz);
    return term1 + term2 + term3;
  }
  else {
    double t = 1./sqrt((z-1)*(z+1));
    double rz = sqrt(abs_zeta);
    double t2 = t*t;
    double term1 = -t2*(81. + 462.*t2 + 385.*t2*t2)/1152.;
    double term2 =  455./(4608.*abs_zeta*abs_zeta*abs_zeta);
    double term3 = -7.*t*( 3 + 5.*t2)/(1152.*rz*rz*rz);
    return term1 + term2 + term3;
  }
}

static double olver_A2(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT4_MACH_EPS) {
    double a = 1.-z;
    return  151439./218295000.
           +68401./147262500.                   * a
           -0.000289036254605598132482570468291 * a*a
	   -0.000874764943953712638574497548110 * a*a*a
	   ;
  }
  else if(z < 1.){
    double t  = 1./sqrt((1-z)*(1+z));
    double t2 = t*t;
    double t4 = t2*t2;
    double t6 = t4*t2;
    double t8 = t4*t4;
    double rz = sqrt(abs_zeta);
    double z3 = abs_zeta*abs_zeta*abs_zeta;
    double z32 = rz*rz*rz;
    double z92 = z3*z32;
    double term1 = t4*(4465125. - 94121676.*t2 + 349922430.*t4 - 446185740.*t6  + 185910725.*t8)/39813120.;
    double term2 = -40415375./(127401984.*z3*z3);
    double term3 = -95095./15925248.*t*(3.-5.*t2)/z92;
    double term4 = -455./5308416. *t2*(81. - 462.*t2 + 385.*t4)/z3;
    double term5 = -7./19906560.*t*t2*(30375. - 369603.*t2  + 765765.*t4  - 425425.*t6)/z32;
    return term1 + term2 + term3 + term4 + term5;
  }
  else {
    double x  = 2./z -1.;
    return (1+x) * gsl_sf_cheb_eval(x, &A2_gt1_cs);
  }
}

static double olver_A3(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT5_MACH_EPS) {
    double a = 1.-z;
    return -0.00035421197145774384077112575920
           -0.000312322527890318832782774881353 * a
	   +0.000277947465383133980329617631915 * a*a
	   +0.000919803044747966977054155192400 * a*a*a
	   +0.001147600388275977640983696906320 * a*a*a*a
	   ;
  }
  else if(z < 1.){
    double x = 2.*sqrt(z) - 1.;
    double f = 1./((1-x)*(1+x));
    return f * gsl_sf_cheb_eval(x, &A3_lt1_cs);
  }
  else {
    double x = 2./z -1.;
    double f = (1+x)*(1+x)*(1+x);
    return f * gsl_sf_cheb_eval(x, &A3_gt1_cs);
  }
}

static double olver_A4(double z, double abs_zeta)
{
  if(fabs(1.-z) < GSL_ROOT4_MACH_EPS) {
    double a = 1.-z;
    return  0.00037819419920177291402661228437
           +0.00040494390552363233477213857527 * a
	   -0.00045764735528936113047289344569 * a*a
	   -0.00165361044229650225813161341879 * a*a*a
	   -0.00217527517983360049717137015539 * a*a*a*a
	   ;
  }
  else if(z < 1.){
    double x = 2.*sqrt(z) - 1.;
    double f = 1./((1-x)*(1+x));
    return f * gsl_sf_cheb_eval(x, &A4_lt1_cs);
  }
  else {
    double x = 2./z -1.;
    double f = (1+x)*(1+x)*(1+x);
    return f*f * gsl_sf_cheb_eval(x, &A4_gt1_cs);
  }
}


void plot_it(void)
{
  double z;
  double abs_zeta, zeta;

  for(z=0.; z<10.; z += .001) {
    double rt = sqrt(fabs(1-z)*(1+z));
    if(fabs(1-z) < GSL_ROOT3_MACH_EPS) {
      /* z near 1 */
      double a = 1.-z;
      zeta = CubeRoot2_*a*(1. + 3./10.*a + 32./175.*a*a);
      abs_zeta = fabs(zeta);
    }
    else if(z < 1.) {
      /* z < 1 */
      abs_zeta = pow(1.5*(log((1+rt)/z) - rt), 2./3.);
      zeta = abs_zeta;
    }
    else {
      /* z > 1 */
      abs_zeta = pow(1.5*(rt - acos(1./z)), 2./3.);
      zeta = -abs_zeta;
    }
    
    printf("%20.14g %20.14g %20.14g   %20.14g  %20.14g  %20.14g  %20.14g  %20.14g  %20.14g  %20.14g  %20.14g\n",
           z, zeta, abs_zeta,
           olver_A1(z, abs_zeta),
	   olver_A2(z, abs_zeta),
	   olver_A3(z, abs_zeta),
	   olver_A4(z, abs_zeta),
           olver_B0(z, abs_zeta),
	   olver_B1(z, abs_zeta),
	   olver_B2(z, abs_zeta),
	   olver_B3(z, abs_zeta)
	   );
  }
}

static double olver_Asum(double nu, double z, double abs_zeta)
{
  double nu2 = nu*nu;
  double A1 = olver_A1(z, abs_zeta);
  double A2 = olver_A2(z, abs_zeta);
  double A3 = olver_A3(z, abs_zeta);
  double A4 = olver_A4(z, abs_zeta);
  return 1. + A1/nu2 + A2/(nu2*nu2) + A3/(nu2*nu2*nu2) + A4/(nu2*nu2*nu2*nu2);
}

static double olver_Bsum(double nu, double z, double abs_zeta)
{
  double nu2 = nu*nu;
  double B0 = olver_B0(z, abs_zeta);
  double B1 = olver_B1(z, abs_zeta);
  double B2 = olver_B2(z, abs_zeta);
  double B3 = olver_B3(z, abs_zeta);
  return B0 + B1/nu2 + B2/(nu2*nu2) + B3/(nu2*nu2*nu2*nu2);
}


int gsl_sf_bessel_Jnu_asymp_Olver_impl(double nu, double x, double * result)
{
  if(x <= 0. || nu <= 0.) {
    return GSL_EDOM;
  }  
  else {
    double zeta, abs_zeta;
    double arg;
    double pre;
    double asum, bsum;
    double ai, aip;
    double z = x/nu;
    double crnu = pow(nu, 1./3.);
    double rt   = sqrt(fabs(1.-z)*(1+z));
    
    if(fabs(1-z) < GSL_SQRT_MACH_EPS) {
      /* z near 1 */
      pre  = CubeRoot2_*(0.5 + 2./5.*(1-z) + 51./175.*(1-z)*(1-z));
      zeta = CubeRoot2_*(1-z)*(1. + 3./10.*(1-z));
      abs_zeta = fabs(zeta);
    }
    else if(z < 1.) {
      /* z < 1 */
      abs_zeta = pow(1.5*(log((1+rt)/z) - rt), 2./3.);
      zeta = abs_zeta;
      pre  = sqrt(sqrt(4.*abs_zeta/(rt*rt)));
    }
    else {
      /* z > 1 */
      abs_zeta = pow(1.5*(rt - acos(1./z)), 2./3.);
      zeta = -abs_zeta;
      pre  = sqrt(sqrt(4.*abs_zeta/(rt*rt)));
    }

    asum = olver_Asum(nu, z, abs_zeta);
    bsum = olver_Bsum(nu, z, abs_zeta);
    arg  = crnu*crnu * zeta;
    gsl_sf_airy_Ai_impl(arg, &ai);
    gsl_sf_airy_Ai_deriv_impl(arg, &aip);

    *result = pre * (ai*asum/crnu + aip*bsum/(nu*crnu*crnu));
    return GSL_SUCCESS;
  }
}

int gsl_sf_bessel_Ynu_asymp_Olver_impl(double nu, double x, double * result)
{
  if(x <= 0. || nu <= 0.) {
    return GSL_EDOM;
  }  
  else {
    double zeta, abs_zeta;
    double arg;
    double pre;
    double asum, bsum;
    double bi, bip;
    double z = x/nu;
    double crnu = pow(nu, 1./3.);
    double rt   = sqrt(fabs(1.-z)*(1+z));
    
    if(fabs(1-z) < GSL_SQRT_MACH_EPS) {
      /* z near 1 */
      pre  = CubeRoot2_*(0.5 + 2./5.*(1-z) + 51./175.*(1-z)*(1-z));
      zeta = CubeRoot2_*(1-z)*(1. + 3./10.*(1-z));
      abs_zeta = fabs(zeta);
    }
    else if(z < 1.) {
      /* z < 1 */
      abs_zeta = pow(1.5*(log((1+rt)/z) - rt), 2./3.);
      zeta = abs_zeta;
      pre  = sqrt(sqrt(4.*abs_zeta/(rt*rt)));
    }
    else {
      /* z > 1 */
      abs_zeta = pow(1.5*(rt - acos(1./z)), 2./3.);
      zeta = -abs_zeta;
      pre  = sqrt(sqrt(4.*abs_zeta/(rt*rt)));
    }

    asum = olver_Asum(nu, z, abs_zeta);
    bsum = olver_Bsum(nu, z, abs_zeta);
    arg  = crnu*crnu * zeta;
    gsl_sf_airy_Bi_impl(arg, &bi);
    gsl_sf_airy_Bi_deriv_impl(arg, &bip);

    *result = -pre * (bi*asum/crnu + bip*bsum/(nu*crnu*crnu));
    return GSL_SUCCESS;
  }
}
